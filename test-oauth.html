<!DOCTYPE html>
<html>
<head>
    <title>OAuth Test - Federated Memory</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 50px auto;
            padding: 20px;
        }
        .auth-buttons {
            display: flex;
            gap: 20px;
            margin: 20px 0;
        }
        .auth-button {
            padding: 10px 20px;
            font-size: 16px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            text-decoration: none;
            display: inline-block;
        }
        .google {
            background-color: #4285f4;
            color: white;
        }
        .github {
            background-color: #24292e;
            color: white;
        }
        .status {
            margin: 20px 0;
            padding: 10px;
            border-radius: 5px;
        }
        .success {
            background-color: #d4edda;
            color: #155724;
        }
        .error {
            background-color: #f8d7da;
            color: #721c24;
        }
        .user-info {
            background-color: #f0f0f0;
            padding: 15px;
            border-radius: 5px;
            margin: 20px 0;
        }
        pre {
            background-color: #f5f5f5;
            padding: 10px;
            border-radius: 3px;
            overflow-x: auto;
        }
    </style>
</head>
<body>
    <h1>OAuth Test - Federated Memory</h1>
    
    <div class="auth-buttons">
        <a href="/api/auth/google" class="auth-button google">Sign in with Google</a>
        <a href="/api/auth/github" class="auth-button github">Sign in with GitHub</a>
    </div>
    
    <div id="status"></div>
    <div id="userInfo"></div>
    
    <h2>Test MCP OAuth Flow</h2>
    <p>This simulates how Claude.ai would authenticate:</p>
    <button onclick="testMCPOAuth()">Test MCP OAuth Flow</button>
    <div id="mcpStatus"></div>
    
    <script>
        // Check URL parameters for OAuth success/failure
        const urlParams = new URLSearchParams(window.location.search);
        const token = urlParams.get('token');
        const provider = urlParams.get('provider');
        const error = urlParams.get('error');
        
        const statusDiv = document.getElementById('status');
        const userInfoDiv = document.getElementById('userInfo');
        
        if (token) {
            statusDiv.className = 'status success';
            statusDiv.textContent = `Successfully authenticated with ${provider}!`;
            
            // Store token
            localStorage.setItem('authToken', token);
            
            // Get user info
            fetchUserInfo(token);
        } else if (error) {
            statusDiv.className = 'status error';
            statusDiv.textContent = `Authentication failed: ${error}`;
        }
        
        // Check if already authenticated
        const storedToken = localStorage.getItem('authToken');
        if (storedToken && !token) {
            fetchUserInfo(storedToken);
        }
        
        async function fetchUserInfo(authToken) {
            try {
                const response = await fetch('/api/auth/me', {
                    headers: {
                        'Authorization': `Bearer ${authToken}`
                    }
                });
                
                if (response.ok) {
                    const user = await response.json();
                    userInfoDiv.className = 'user-info';
                    userInfoDiv.innerHTML = `
                        <h3>Authenticated User</h3>
                        <p><strong>ID:</strong> ${user.id}</p>
                        <p><strong>Email:</strong> ${user.email}</p>
                        <p><strong>Name:</strong> ${user.name || 'N/A'}</p>
                        <p><strong>Provider:</strong> ${user.provider || 'N/A'}</p>
                        ${user.avatarUrl ? `<img src="${user.avatarUrl}" alt="Avatar" style="width: 50px; height: 50px; border-radius: 50%;">` : ''}
                        <br><br>
                        <button onclick="logout()">Logout</button>
                    `;
                }
            } catch (err) {
                console.error('Failed to fetch user info:', err);
            }
        }
        
        async function logout() {
            try {
                await fetch('/api/auth/logout', { method: 'POST' });
                localStorage.removeItem('authToken');
                window.location.reload();
            } catch (err) {
                console.error('Logout failed:', err);
            }
        }
        
        async function testMCPOAuth() {
            const mcpStatusDiv = document.getElementById('mcpStatus');
            mcpStatusDiv.innerHTML = '<p>Starting MCP OAuth flow...</p>';
            
            // Simulate MCP client parameters
            const params = new URLSearchParams({
                response_type: 'code',
                client_id: 'mcp-test-client-' + Date.now(),
                redirect_uri: window.location.origin + '/mcp-callback',
                code_challenge: 'test-challenge-' + Math.random().toString(36).substring(7),
                code_challenge_method: 'S256',
                state: 'test-state-' + Math.random().toString(36).substring(7)
            });
            
            // Redirect to OAuth authorize endpoint
            window.location.href = `/api/oauth/authorize?${params.toString()}`;
        }
        
        // Handle MCP callback
        if (window.location.pathname === '/mcp-callback') {
            const code = urlParams.get('code');
            const state = urlParams.get('state');
            
            if (code) {
                document.body.innerHTML = `
                    <h2>MCP OAuth Callback</h2>
                    <p class="status success">Authorization successful!</p>
                    <pre>Code: ${code}\nState: ${state}</pre>
                    <p>In a real MCP client, this code would now be exchanged for an access token.</p>
                    <a href="/test-oauth.html">Back to test page</a>
                `;
            }
        }
    </script>
</body>
</html>